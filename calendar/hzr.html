<!DOCTYPE html>
<!-- xlsx.js (C) 2013-present  SheetJS http://sheetjs.com -->
<!-- vim: set ts=2: -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>HZR-Calendar</title>
<style>
#drop{
	border:2px dashed #bbb;
	-moz-border-radius:5px;
	-webkit-border-radius:5px;
	border-radius:5px;
	padding:25px;
	text-align:center;
	font:20pt bold,"Vollkorn";color:#bbb
}
#b64data{
	width:100%;
}
.fc-time{
	display: none;
}
a { text-decoration: none }
</style>
		<link href='./css/fullcalendar.min.css' rel='stylesheet' />
		<link href='./css/fullcalendar.print.min.css' rel='stylesheet' media='print' />
		<script src='./js/moment.min.js'></script>
		<script src='./js/jquery.min.js'></script>
		<script src='./js/fullcalendar.min.js'></script>
		<script src='./js/html2canvas.min.js'></script>
		<script src='./js/canvas2image.js'></script>

		<script>
			$(function(){
				$('#calendar').fullCalendar({
					header: {
						left: 'prev,next today',
						center: 'title',
						right: 'month,basicWeek,basicDay'
					},
					buttonText:{
						'today':'今天',
						'month':'月',
						'week':'周',
						'day':'日'
					},
					monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],
					monthNamesShort:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],
					dayNames:['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'],
					dayNamesShort:['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'],
					firstDay:1,
					editable: true,
					timeFormat: 'H:mm',
					axisFormat: 'H:mm',
					navLinks: true, // can click day/week names to navigate views
					editable: true,
					eventLimit: true, // allow "more" link when too many events
					events: [
					]
				});
			});
		</script>
		<style>

			body {
				margin: 40px 10px;
				padding: 0;
				font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
				font-size: 14px;
			}

			#calendar {
				max-width: 900px;
				margin: 0 auto;
			}
			th.fc-mon,th.fc-tue,th.fc-wed,th.fc-thu,th.fc-fri{
				background-color: #7F7F7F;
			}
			th.fc-day-header{
				padding-top: 8px;
				padding-bottom: 8px;
			}
			th.fc-sat,th.fc-sun{
				background-color: #FF1E00
			}

		</style>
</head>
<body>
<!-- <pre> -->
(拖拽方式支持：IE10+ Chrome)<select name="format" onchange="setfmt()" display="none" style="display:none">
<option value="json" selected> json</option>
</select><br />
<div id="drop">Drop a spreadsheet file here to see sheet data</div>
<!-- <input type="file" name="xlfile" id="xlf" /> ... or click here to select a file -->

<!-- <textarea id="b64data">... or paste a base64-encoding here</textarea> -->
<!-- <input type="button" id="dotext" value="Click here to process the base64 text" onclick="b64it();"/><br /> -->
<!-- <b>Advanced Demo Options:</b> -->
<div hidden="hidden">
Use Web Workers: (when available) <input type="checkbox" name="useworker" checked>
Use Transferrables: (when available) <input type="checkbox" name="xferable" checked>
Use readAsBinaryString: (when available) <input type="checkbox" name="userabs" checked>
</div>
<!-- </pre> -->
 <!-- <pre id="out"></pre>
<div id="htmlout"></div> -->
<br />
<!-- uncomment the next line here and in xlsxworker.js for encoding support -->
		<div style="margin:20px">
			<input type="button" id="toImageBt" value="日历->图片">
			<a href="" id="downloadImage" style="display:none;">downloadImage</a>
		</div>
		<div id='calendar'></div>

<script src="dist/cpexcel.js"></script>
<script src="shim.js"></script>
<script src="jszip.js"></script>
<script src="xlsx.js"></script>
<script>
/*jshint browser:true */
/*global XLSX */
var X = XLSX;
var XW = {
	/* worker message */
	msg: 'xlsx',
	/* worker scripts */
	rABS: './xlsxworker2.js',
	norABS: './xlsxworker1.js',
	noxfer: './xlsxworker.js'
};

var rABS = typeof FileReader !== "undefined" && typeof FileReader.prototype !== "undefined" && typeof FileReader.prototype.readAsBinaryString !== "undefined";
if(!rABS) {
	document.getElementsByName("userabs")[0].disabled = true;
	document.getElementsByName("userabs")[0].checked = false;
}

var use_worker = typeof Worker !== 'undefined';
if(!use_worker) {
	document.getElementsByName("useworker")[0].disabled = true;
	document.getElementsByName("useworker")[0].checked = false;
}

var transferable = use_worker;
if(!transferable) {
	document.getElementsByName("xferable")[0].disabled = true;
	document.getElementsByName("xferable")[0].checked = false;
}

var wtf_mode = false;

function fixdata(data) {
	var o = "", l = 0, w = 10240;
	for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint8Array(data.slice(l*w,l*w+w)));
	o+=String.fromCharCode.apply(null, new Uint8Array(data.slice(l*w)));
	return o;
}

function ab2str(data) {
	var o = "", l = 0, w = 10240;
	for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(data.slice(l*w,l*w+w)));
	o+=String.fromCharCode.apply(null, new Uint16Array(data.slice(l*w)));
	return o;
}

function s2ab(s) {
	var b = new ArrayBuffer(s.length*2), v = new Uint16Array(b);
	for (var i=0; i != s.length; ++i) v[i] = s.charCodeAt(i);
	return [v, b];
}

function xw_noxfer(data, cb) {
	var worker = new Worker(XW.noxfer);
	worker.onmessage = function(e) {
		switch(e.data.t) {
			case 'ready': break;
			case 'e': console.error(e.data.d); break;
			case XW.msg: cb(JSON.parse(e.data.d)); break;
		}
	};
	var arr = rABS ? data : btoa(fixdata(data));
	worker.postMessage({d:arr,b:rABS});
}

function xw_xfer(data, cb) {
	var worker = new Worker(rABS ? XW.rABS : XW.norABS);
	worker.onmessage = function(e) {
		switch(e.data.t) {
			case 'ready': break;
			case 'e': console.error(e.data.d); break;
			default: xx=ab2str(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r"); console.log("done"); cb(JSON.parse(xx)); break;
		}
	};
	if(rABS) {
		var val = s2ab(data);
		worker.postMessage(val[1], [val[1]]);
	} else {
		worker.postMessage(data, [data]);
	}
}

function xw(data, cb) {
	transferable = document.getElementsByName("xferable")[0].checked;
	if(transferable) xw_xfer(data, cb);
	else xw_noxfer(data, cb);
}

function get_radio_value( radioName ) {
	var radios = document.getElementsByName( radioName );
	for( var i = 0; i < radios.length; i++ ) {
		if( radios[i].checked || radios.length === 1 ) {
			return radios[i].value;
		}
	}
}

function to_json(workbook) {
	var result = {};
	workbook.SheetNames.forEach(function(sheetName) {
		var roa = X.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
		if(roa.length > 0){
			result[sheetName] = roa;
		}
	});
	return result;
}
function to_csv(workbook) {
	var result = [];
	workbook.SheetNames.forEach(function(sheetName) {
		var csv = X.utils.sheet_to_csv(workbook.Sheets[sheetName]);
		if(csv.length > 0){
			result.push("SHEET: " + sheetName);
			result.push("");
			result.push(csv);
		}
	});
	return result.join("\n");
}

function to_formulae(workbook) {
	var result = [];
	workbook.SheetNames.forEach(function(sheetName) {
		var formulae = X.utils.get_formulae(workbook.Sheets[sheetName]);
		if(formulae.length > 0){
			result.push("SHEET: " + sheetName);
			result.push("");
			result.push(formulae.join("\n"));
		}
	});
	return result.join("\n");
}

function to_html(workbook) {
	document.getElementById('htmlout').innerHTML = "";
	var result = [];
	workbook.SheetNames.forEach(function(sheetName) {
		var htmlstr = X.write(workbook, {sheet:sheetName, type:'binary', bookType:'html'});
		document.getElementById('htmlout').innerHTML += htmlstr;
	});
}

var tarea = document.getElementById('b64data');
function b64it() {
	if(typeof console !== 'undefined') console.log("onload", new Date());
	var wb = X.read(tarea.value, {type: 'base64',WTF:wtf_mode});
	process_wb(wb);
}

var global_wb;
function process_wb(wb) {
	global_wb = wb;
	var output = "";
	switch(get_radio_value("format")) {
		case "json":
			output = to_json(wb);
			break;
		case "form":
			output = to_formulae(wb);
			break;
		case "html": return to_html(wb);
		default:
			output = to_csv(wb);
	}
	processData(output);
	// alert(output);
	//  if(out.innerText === undefined) out.textContent = output;
	//  else out.innerText = output;
	if(typeof console !== 'undefined') console.log("output", new Date());
}
var colors={'区域市场部':'#F9C090','销售自主活动':'#B3A2C7','中央市场部':'#C01300','PE':'#C3D69B'};

function processData(msg) {
	if (null == msg) {
		alert("处理失败或数据格式不正确!")
	}
	var data = msg.Sheet1;
	if (null == data) {
		alert("请确定表格内存在Sheet1的表格");
	}
	var events = [];
	$.each(data, function(index, item){
		if (undefined != item.活动名称 && null != item.活动名称 && undefined != item.活动开始时间 && null != item.活动开始时间) {
			var event = {"title":item.活动名称,"start":new Date($.trim(item.活动开始时间.replace("年","/").replace("月","/").replace("日", ""))),
					"end":new Date($.trim(item.活动结束时间.replace("年","/").replace("月","/").replace("日", " 23:59:59"))),"color":colors[item.活动类型]};

			events.push(event);
					console.log(item.活动名称+$.trim(item.活动开始时间.replace("年","/").replace("月","/").replace("日", "")));
					console.log($.trim(item.活动结束时间.replace("年","/").replace("月","/").replace("日", "")));
		}
	})
	// alert(events);
	// $.each(msg, function(i, item){
	// 	alert(i);
	// 	alert(item);
	// });
	//$('#calendar').fullCalendar('removeEvents');
	$('#calendar').fullCalendar('addEventSource', events);
	//console.log(JSON.stringify(msg, 2, 2));

}
function setfmt() {if(global_wb) process_wb(global_wb); }

var drop = document.getElementById('drop');
function handleDrop(e) {
	e.stopPropagation();
	e.preventDefault();
	rABS = document.getElementsByName("userabs")[0].checked;
	use_worker = document.getElementsByName("useworker")[0].checked;
	var files = e.dataTransfer.files;
	var f = files[0];
	{
		var reader = new FileReader();
		var name = f.name;
		reader.onload = function(e) {
			if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
			var data = e.target.result;
			if(use_worker) {
				xw(data, process_wb);
			} else {
				var wb;
				if(rABS) {
					wb = X.read(data, {type: 'binary'});
				} else {
					var arr = fixdata(data);
					wb = X.read(btoa(arr), {type: 'base64'});
				}
				process_wb(wb);
			}
		};
		if(rABS) reader.readAsBinaryString(f);
		else reader.readAsArrayBuffer(f);
	}
}

function handleDragover(e) {
	e.stopPropagation();
	e.preventDefault();
	e.dataTransfer.dropEffect = 'copy';
}

if(drop.addEventListener) {
	drop.addEventListener('dragenter', handleDragover, false);
	drop.addEventListener('dragover', handleDragover, false);
	drop.addEventListener('drop', handleDrop, false);
}
function saveHtml2Image(objId, scale) {
            document.body.scrollTop = 0;
            var obj = $("#" + objId);
            var width = obj.width();
            var height = obj.height();
            html2canvas(obj, {
                width: width,
                height: height,
                background: "rgba(255,255,255,1)",
                onrendered: function (canvas) {
                    var dataUrl = Canvas2Image.saveAsPNG(canvas, parseInt(width * scale), parseInt(height * scale));
                    var totalSize = dataUrl.length / 1024 / 1024;
                    if (totalSize > 1.3) {
                        dataUrl = null;
                        scale = scale - 0.1;
                        saveHtml2Image(objId, scale);
                    }
                    else {
                        $('#downloadImage').attr('href', dataUrl);
                        $('#downloadImage').attr('download', 'test.jpg');
                        $('#downloadImage')[0].click();
                    }
                }
            });
        }

 $("#toImageBt").click(function(){
	 	saveHtml2Image("calendar", 1);
 })
var xlf = document.getElementById('xlf');
function handleFile(e) {
	rABS = document.getElementsByName("userabs")[0].checked;
	use_worker = document.getElementsByName("useworker")[0].checked;
	var files = e.target.files;
	var f = files[0];
	{
		var reader = new FileReader();
		var name = f.name;
		reader.onload = function(e) {
			if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
			var data = e.target.result;
			if(use_worker) {
				xw(data, process_wb);
			} else {
				var wb;
				if(rABS) {
					wb = X.read(data, {type: 'binary'});
				} else {
					var arr = fixdata(data);
					wb = X.read(btoa(arr), {type: 'base64'});
				}
				process_wb(wb);
			}
		};
		if(rABS) reader.readAsBinaryString(f);
		else reader.readAsArrayBuffer(f);
	}
}

//if(xlf.addEventListener) xlf.addEventListener('change', handleFile, false);
</script>
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-36810333-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body>
</html>
